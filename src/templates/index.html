<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMS 问答系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#f3f4f6',
                        user: '#e3f2fd',
                        ai: '#f5f5f5',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .message-appear {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex flex-col h-screen max-h-screen">
        <!-- 头部 -->
        <header class="bg-primary text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">BMS 问答系统</h1>
                <div id="status-indicator" class="flex items-center">
                    <span id="status-text">初始化中...</span>
                    <div id="status-spinner" class="ml-2 w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>
        </header>

        <!-- 聊天区域 -->
        <main class="flex-1 overflow-y-auto p-4 bg-gray-50 scrollbar-hide" id="chat-container">
            <div class="container mx-auto max-w-3xl space-y-6">
                <!-- 系统消息 -->
                <div class="message-appear">
                    <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 bg-primary text-white rounded-full p-2 mr-3">
                                <i class="fa fa-info"></i>
                            </div>
                            <div>
                                <p class="text-gray-800">欢迎使用 BMS 问答系统，请等待系统初始化完成后提问。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 输入区域 -->
        <footer class="bg-white border-t border-gray-200 p-4">
            <div class="container mx-auto max-w-3xl">
                <form id="question-form" class="flex flex-col space-y-2">
                    <div class="relative">
                        <textarea
                            id="question-input"
                            placeholder="请输入您的问题..."
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none"
                            rows="3"
                            disabled
                        ></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button
                            type="submit"
                            id="submit-btn"
                            class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-all disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center"
                            disabled
                        >
                            <span>发送</span>
                            <i class="fa fa-paper-plane ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chat-container');
            const questionForm = document.getElementById('question-form');
            const questionInput = document.getElementById('question-input');
            const submitBtn = document.getElementById('submit-btn');
            const statusText = document.getElementById('status-text');
            const statusSpinner = document.getElementById('status-spinner');

            // 检查系统初始化状态
            function checkInitialization() {
                fetch('/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.initialized) {
                            statusSpinner.classList.remove('animate-spin');
                            if (data.error) {
                                statusText.textContent = '初始化失败';
                                addSystemMessage(`系统初始化失败: ${data.error}`, 'error');
                            } else {
                                statusText.textContent = '已就绪';
                                questionInput.disabled = false;
                                submitBtn.disabled = false;
                                addSystemMessage('系统已准备就绪，您可以开始提问了。', 'success');
                            }
                        } else {
                            // 未初始化完成，继续检查
                            setTimeout(checkInitialization, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('检查初始化状态失败:', error);
                        setTimeout(checkInitialization, 2000);
                    });
            }

            // 添加系统消息
            function addSystemMessage(text, type = 'info') {
                const messageClass = type === 'error' ? 'bg-red-50' :
                                   type === 'success' ? 'bg-green-50' : 'bg-blue-50';
                const iconClass = type === 'error' ? 'fa-exclamation-circle text-red-500' :
                                 type === 'success' ? 'fa-check-circle text-green-500' : 'fa-info-circle text-blue-500';

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-appear';
                messageDiv.innerHTML = `
                    <div class="${messageClass} p-4 rounded-lg shadow-sm">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 rounded-full p-2 mr-3">
                                <i class="fa ${iconClass}"></i>
                            </div>
                            <div>
                                <p class="text-gray-800">${text}</p>
                            </div>
                        </div>
                    </div>
                `;
                chatContainer.querySelector('.space-y-6').appendChild(messageDiv);
                scrollToBottom();
            }

            // 添加用户消息
            function addUserMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-appear';
                messageDiv.innerHTML = `
                    <div class="bg-user p-4 rounded-lg shadow-sm ml-auto max-w-[85%]">
                        <div class="flex items-start">
                            <div class="flex-1">
                                <p class="text-gray-800">${text}</p>
                            </div>
                            <div class="flex-shrink-0 bg-blue-500 text-white rounded-full p-2 ml-3">
                                <i class="fa fa-user"></i>
                            </div>
                        </div>
                    </div>
                `;
                chatContainer.querySelector('.space-y-6').appendChild(messageDiv);
                scrollToBottom();
                return messageDiv;
            }

            // 添加AI消息容器并返回用于更新的元素
            function addAiMessageContainer() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-appear';
                messageDiv.innerHTML = `
                    <div class="bg-ai p-4 rounded-lg shadow-sm mr-auto max-w-[85%]">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 bg-gray-400 text-white rounded-full p-2 mr-3">
                                <i class="fa fa-robot"></i>
                            </div>
                            <div class="flex-1">
                                <div class="ai-response"></div>
                                <div class="loading-indicator hidden mt-2">
                                    <div class="flex space-x-1">
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                chatContainer.querySelector('.space-y-6').appendChild(messageDiv);
                scrollToBottom();

                return {
                    container: messageDiv,
                    responseElement: messageDiv.querySelector('.ai-response'),
                    loadingIndicator: messageDiv.querySelector('.loading-indicator')
                };
            }

            // 滚动到底部
            function scrollToBottom() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // 处理表单提交
            questionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const question = questionInput.value.trim();

                if (!question) return;

                // 清空输入框
                questionInput.value = '';

                // 添加用户消息
                addUserMessage(question);

                // 添加AI消息容器
                const aiMessage = addAiMessageContainer();
                aiMessage.loadingIndicator.classList.remove('hidden');

                // 发送请求
                fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('请求失败');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponse = '';

                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                aiMessage.loadingIndicator.classList.add('hidden');
                                return;
                            }

                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n');

                            lines.forEach(line => {
                                if (line.startsWith('data:')) {
                                    try {
                                        const data = JSON.parse(line.substring(5).trim());
                                        if (data.token) {
                                            aiResponse += data.token;
                                            aiMessage.responseElement.innerHTML = aiResponse.replace(/\n/g, '<br>');
                                            scrollToBottom();
                                        }
                                    } catch (e) {
                                        console.error('解析响应失败:', e);
                                    }
                                } else if (line.startsWith('event: error')) {
                                    try {
                                        const dataLine = lines[lines.indexOf(line) + 1];
                                        if (dataLine && dataLine.startsWith('data:')) {
                                            const data = JSON.parse(dataLine.substring(5).trim());
                                            aiMessage.responseElement.innerHTML = `<span class="text-red-500">错误: ${data.message}</span>`;
                                        }
                                    } catch (e) {
                                        console.error('解析错误响应失败:', e);
                                    }
                                    aiMessage.loadingIndicator.classList.add('hidden');
                                } else if (line.startsWith('event: complete')) {
                                    aiMessage.loadingIndicator.classList.add('hidden');
                                }
                            });

                            read();
                        }).catch(error => {
                            console.error('读取响应失败:', error);
                            aiMessage.responseElement.innerHTML = `<span class="text-red-500">获取答案时出错</span>`;
                            aiMessage.loadingIndicator.classList.add('hidden');
                        });
                    }

                    read();
                })
                .catch(error => {
                    console.error('发送请求失败:', error);
                    aiMessage.responseElement.innerHTML = `<span class="text-red-500">发送请求时出错</span>`;
                    aiMessage.loadingIndicator.classList.add('hidden');
                });
            });

            // 初始化检查
            checkInitialization();

            // 调整textarea高度
            questionInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight > 100 ? 100 : this.scrollHeight) + 'px';
            });
        });
    </script>
</body>
</html>
